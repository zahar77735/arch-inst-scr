#!/bin/bash
clear
loadkeys ru
setfont cyr-sun16
#echo 'Скрипт сделан на основе чеклиста Бойко Алексея по Установке ArchLinux'
#echo 'Ссылка на чек лист есть в группе vk.com/arch4u'

echo 'Синхронизация системных часов'
timedatectl set-ntp true

echo 'Создание разделов'

echo 'Ваша разметка диска'
lsblk

read -p 'Выбрать диск? ' xhdd
fdisk /dev/$xhdd
read -p "Выберите раздел куда будет установлена система: " rootsection
read -p "Введите имя метки тома: " mark
read -p "Выберите раздел для boot: " efi
mkfs.btrfs -f -L $mark /dev/$rootsection
mkfs.fat -F 32 /dev/$efi
mount /dev/$rootsection /mnt
btrfs subvolume create /mnt/sv_root
btrfs subvolume create /mnt/sv_home
btrfs subvolume create /mnt/sv_snapshots
umount /mnt
mount -o subvol=sv_root,defaults,noatime,autodefrag,compress=zstd,discard=async,ssd /dev/$rootsection /mnt
mkdir /mnt/boot
mkdir /mnt/home
mkdir /mnt/snapshots
mount -o subvol=sv_home,defaults,noatime,autodefrag,compress=zstd,discard=async,ssd /dev/$rootsection /mnt/home
mount -o subvol=sv_snapshots,defaults,noatime,autodefrag,compress=zstd,discard=async,ssd /dev/$rootsection /mnt/snapshots
mount /dev/$efi /mnt/boot

echo 'Выбор зеркал для загрузки.'
pacman -S reflector --noconfirm && reflector --verbose  -l 5 -p https --sort rate --save /etc/pacman.d/mirrorlist && pacman -Sy

echo 'Установка основных пакетов'
pacstrap /mnt base base-devel linux-zen linux-firmware linux-zen-headers intel-ucode nano dhcpcd netctl btrfs-progs

genfstab -pU /mnt >> /mnt/etc/fstab

arch-chroot /mnt sh -c "$(curl -fsSL git.io/inst2)"
