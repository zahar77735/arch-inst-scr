#!/bin/bash
clear
loadkeys ru
setfont cyr-sun16
#echo 'Скрипт сделан на основе чеклиста Бойко Алексея по Установке ArchLinux'
#echo 'Ссылка на чек лист есть в группе vk.com/arch4u'

echo '2.3 Синхронизация системных часов'
timedatectl set-ntp true

echo '2.4 создание разделов'

echo 'Ваша разметка диска'
lsblk

read -p "Выбор диска: " devsection
cfdisk /dev/$devsection

read -p "Выбор файловой системы. либо EXT4 -e, либо BTRFS -b [B/e] " newfs
if [[ -z $newfs || $newfs == b || $newfs == B ]]; then
 read -p "На диске имеется swap раздел? [Y/n] " new_system
  if [[ -z $new_system || $new_system == y || $new_system == Y ]]
   then read -p "Выбор системного раздела: " rootsection
   echo '2.4.2 Форматирование диска'
   read -p "Введите имя метки тома :" mark
   mkfs.btrfs -f -L $mark /dev/$rootsection
   echo '2.4.3 Монтирование диска'
   mount /dev/$rootsection /mnt
   echo '2.4.4 Создание подтомов'
   btrfs subvolume create /mnt/@
   btrfs subvolume create /mnt/@home
   btrfs subvolume list /mnt
   umount /mnt
   mount -o subvol=@,compress=lzo,relatime,space_cache,autodefrag /dev/$rootsection /mnt
   mkdir /mnt/home
   mount -o subvol=@home,compress=lzo,relatime,space_cache,autodefrag /dev/$rootsection /mnt/home
 elif [[ $new_system == n || $new_system == N ]]
   then read -p "Выбор swap раздела: " swapsection
   mkswap /dev/$swapsection -L swap
   swapon /dev/$swapsection
   read -p "Выбор системного раздела: " rootsection
   echo '2.4.2 Форматирование диска'
   read -p "Введите имя метки тома :" mark
   mkfs.btrfs -f -L $mark /dev/$rootsection
   echo '2.4.3 Монтирование диска'
   mount /dev/$rootsection /mnt
   echo '2.4.4 Создание подтомов'
   btrfs subvolume create /mnt/@
   btrfs subvolume create /mnt/@home
   btrfs subvolume list /mnt
   umount /mnt
   mount -o subvol=@,compress=lzo,relatime,space_cache,autodefrag /dev/$rootsection /mnt
   mkdir /mnt/home
   mount -o subvol=@home,compress=lzo,relatime,space_cache,autodefrag /dev/$rootsection /mnt/home
  fi
elif [[ $newfs == e || $newfs == E ]]; then
 read -p "На диске имеется swap раздел? [Y/n] " new_system
  if [[ -z $new_system || $new_system == y || $new_system == Y ]]; then
   read -p "Выбор системного раздела: " rootsection
   echo '2.4.2 Форматирование диска'
   read -p "Введите имя метки тома :" mark
   mkfs.ext4 -L $mark /dev/$rootsection
   mount /dev/$rootsection /mnt
  elif [[ $new_system == n || $new_system == N ]]; then
   read -p "Выбор системного раздела: " rootsection
   echo '2.4.2 Форматирование диска'
   read -p "Введите имя метки тома :" mark
   mkfs.ext4 -L $mark /dev/$rootsection
   mount /dev/$rootsection /mnt
   echo 'Создаём swap файл'
   fallocate -l 8G /mnt/swapfile
   chmod 600 /mnt/swapfile
   echo 'Форматируем swap'
   dd if=/dev/zero of=/mnt/swapfile bs=1024k count=8000
   echo 'Подключаем swap'
   mkswap /mnt/swapfile
   swapon /mnt/swapfile
  fi
fi

echo '3.1 Выбор зеркал для загрузки. Ставим зеркало от Яндекс'
pacman -S reflector
reflector --verbose  -l 5 -p https --sort rate --save /etc/pacman.d/mirrorlist

echo '3.2 Установка основных пакетов'
pacstrap /mnt base base-devel linux-zen linux-firmware linux-zen-headers crda amd-ucode nano dhcpcd netctl

echo '3.3 Настройка системы'
genfstab -pU /mnt >> /mnt/etc/fstab

arch-chroot /mnt sh -c "$(curl -fsSL git.io/inst2)"
